# WHY_STRICT_PARSERS_WIN

> 本文解释一个在工程实践中反复被验证、
> 但在大多数教程里**从未被直说**的事实：
>
> **在边界协议上，宽容解析器一定失败，严格解析器一定胜出。**

---

## 0. 先给结论（给决策者看的）

* 宽容 parser：

  * 短期兼容性 ↑
  * 长期安全性 ↓↓↓
* 严格 parser：

  * 初期“看起来难用”
  * 长期稳定、可维护、可推理

> **所有大型基础设施，最终都会走向严格。**

---

## 1. HTTP 不是业务协议，而是边界协议

### 关键认知

* 业务协议：

  * 错一点还能兜底
  * 可以靠语义补偿
* 边界协议（HTTP / TLS / DNS）：

  * 一点模糊 = 攻击面

> HTTP parser 不是在“服务用户”，
> 而是在**守边界**。

---

## 2. “宽容”的真实含义（残酷版）

当人说 parser 要“宽容”，
通常意味着：

* 忽略非法输入
* 自动修正格式
* 猜测发送方意图

### 在边界协议中，这三点等价于：

> **把解析权让给攻击者。**

---

## 3. 历史已经给过答案

| 系统              | 早期策略   | 结果                |
| --------------- | ------ | ----------------- |
| 浏览器 HTML parser | 极度宽容   | XSS 温床            |
| HTTP/1.x proxy  | 尝试兼容   | Request Smuggling |
| SMTP            | 宽容命令解析 | Spam / Relay      |

后来发生了什么？

> 全部引入了 **更严格的 parsing rules**。

---

## 4. 宽容 parser 的结构性失败点

### 4.1 模糊边界无法组合

宽容意味着：

```text
可能是 A
也可能是 B
```

但系统是组合的：

```text
A + B ≠ 安全
```

> Request Smuggling 正是这种组合失败。

---

### 4.2 “先接受再说”在流协议中不可逆

HTTP 是 **streaming** 的。

一旦你多吃了一个字节：

* 无法回滚
* 无法证明安全

> 严格 parser 的本质：
> **在吃字节之前就知道能不能吃。**

---

## 5. 严格 parser 的三条铁律

### 铁律 1：冲突即失败

* CL + TE
* 多 CL
* 非法 CL

> 没有“容错模式”。

---

### 铁律 2：决策一次，永不回退

```ts
const strategy = decideBodyStrategy(headers);
```

一旦决定：

* framing 固化
* 状态机不可逆

---

### 铁律 3：EOF 不是普通事件

* 在 HTTP/1.x 中：

  * EOF 可能是语义
* 在 HTTP/2 中：

  * EOF 永远是错误

> 严格 parser **显式区分这两种世界**。

---

## 6. 为什么“宽容 = 兼容性”是个假命题

### 现实情况

* 合法客户端 **不会发非法请求**
* 非法请求 99% 来自：

  * bug
  * 攻击

> 为那 1% 的 bug 引入 100% 的攻击面，
> 是基础设施工程中最糟糕的交易。

---

## 7. 大型系统的共同选择

| 系统         | 策略                    |
| ---------- | --------------------- |
| Envoy      | strict by default     |
| Cloudflare | fail-fast             |
| HTTP/2     | structural strictness |

> 它们不是更聪明，
> 而是**交过足够多的学费**。

---

## 8. 对“用户体验”的真实影响

严格 parser 的真实影响：

* 早期暴露 bug
* 强迫上游修正
* 消除隐性不确定性

> 长期来看，
> 整个生态都会更健康。

---

## 9. 实现者自检清单

如果你的 parser：

* [ ] 接受非法 header
* [ ] 自动补 framing
* [ ] 猜测 body 结束

那么结论只有一个：

> **它一定会在未来某个时间点出事故。**

---

## 10. 严格 parser 的真正胜利点

不是安全公告，
不是 PR，
而是：

> **你可以对系统行为进行完整推理。**

这是基础设施工程里，
最稀缺、也最昂贵的能力。

---

## 11. 一句话收尾（你可以贴在 README）

> **在边界协议上，
> 不宽容不是苛刻，
> 而是对系统负责。**
